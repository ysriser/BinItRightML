name: Python PR Validation (Quality Gates)

on:
  pull_request:
    branches: ["master"]

jobs:
  # ==========================================
  # BOX 1: LINTING
  # ==========================================
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Run Ruff
        run: |
          pip install ruff
          # Generate JSON for SonarCloud and text for GitHub logs
          ruff check . --output-format json --output-file ruff-report.json || true
      - name: Upload Lint Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-lint-reports
          path: ruff-report.json

  # ==========================================
  # BOX 2: UNIT TESTS + COVERAGE
  # ==========================================
  unit-tests:
    name: Unit Tests (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # You MUST install pytest-cov to generate coverage.xml
          pip install -r requirements.txt pytest-cov

      - name: Run Pytest with Coverage
        run: |
          # Use --cov=. to measure coverage and --cov-report=xml to create the file
          pytest . \
          --ignore=.venv \
          --ignore=legacy \
          --ignore=reports \
          --ignore=CNN/data \
          --ignore=CNN/models \
          --ignore=CNN/outputs \
          --ignore=tests/test_main.py \
          --junitxml=reports/unit-test.xml \
          --cov=. --cov-report=xml:coverage.xml

      - name: Upload Coverage Reports
        if: always() # Always upload so we can see if it worked
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-reports
          path: coverage.xml

  # ==========================================
  # BOX 3: SCA
  # ==========================================
  sca-scan:
    name: SCA (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy SCA
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          format: "sarif" # CHANGED
          output: "python-sca.sarif" # CHANGED
          exit-code: "0" # Set to 0 so the orchestrator can still run even if vulns exist
          severity: "CRITICAL,HIGH"
      - name: Upload SCA Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-sca-results
          path: python-sca.sarif

  # ==========================================
  # BOX 4: SAST
  # ==========================================
  sast-scan:
    name: SAST (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r . -c bandit.yaml -f json -o bandit-results.json || true
      - name: Upload SAST Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-sast-results
          path: bandit-results.json

  security-report:
    name: Security Testing Report
    needs: [sca-scan, sast-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download SCA Artifact
        uses: actions/download-artifact@v4
        with:
          name: python-sca-results
          path: reports/security
      - name: Download SAST Artifact
        uses: actions/download-artifact@v4
        with:
          name: python-sast-results
          path: reports/security
      - name: Build Security Summary
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          out = Path('reports/security/security-testing-report.md')
          out.parent.mkdir(parents=True, exist_ok=True)

          sca_path = Path('reports/security/sca-report.txt')
          sast_path = Path('reports/security/bandit-results.json')

          sca_high_critical = 0
          if sca_path.exists():
            text = sca_path.read_text(encoding='utf-8', errors='ignore')
            sca_high_critical = sum(1 for line in text.splitlines() if 'HIGH' in line or 'CRITICAL' in line)

          sast_count = 0
          if sast_path.exists():
            try:
              data = json.loads(sast_path.read_text(encoding='utf-8'))
              sast_count = len(data.get('results', []))
            except Exception:
              pass

          out.write_text(
            "# Security Testing Report (PR)\n\n"
            "## Identified Issues\n"
            f"- SCA potential HIGH/CRITICAL lines: {sca_high_critical}\n"
            f"- SAST findings count (Bandit): {sast_count}\n\n"
            "## Fixes Applied\n"
            "- Track fixes in PR commits and code review notes.\n"
            "- Keep this report artifact with each PR run.\n\n"
            "## Re-scanning Results\n"
            "- Re-run this workflow after fixes and compare this report with previous run artifacts.\n",
            encoding='utf-8'
          )
          PY
      - name: Upload Security Testing Report
        uses: actions/upload-artifact@v4
        with:
          name: python-security-testing-report
          path: reports/security/security-testing-report.md

  # ==========================================
  # BOX 4: PYTHON BUILD (Verification)
  # ==========================================
  python-build:
    name: Python Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install wheel setuptools
          pip install -r requirements.txt
      - name: Verify Environment (Dry Run)
        run: |
          # This ensures the app can at least be 'imported' or 
          # that the entry point script is valid.
          python -m compileall .
      - name: Create Build Archive
        run: |
          zip -r python-app-pr.zip . -x "*.git*" "venv/*" "__pycache__/*"
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-app-binary-pr
          path: python-app-pr.zip
          retention-days: 1
