name: Python Master Deployment

on:
  push:
    branches: ["master"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # BOX 4 & 5: BUILD & DOCKERIZATION
  # ==========================================
  docker-push:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login to DigitalOcean
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: _
          password: ${{ secrets.DO_ACCESS_TOKEN }}
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            registry.digitalocean.com/binitright/python-ml-app:${{ github.sha }}
            registry.digitalocean.com/binitright/python-ml-app:master

  # ==========================================
  # BOX 6: DEPLOY TO TEST
  # ==========================================
  deploy-test:
    name: Deploy to Test
    needs: docker-push
    runs-on: ubuntu-latest
    environment: test
    steps:
      - uses: actions/checkout@v4
      - name: SSH Deploy to Test
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TEST_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export PYTHON_IMAGE=registry.digitalocean.com/binitright/python-ml-app:${{ github.sha }}
            docker login -u _ -p ${{ secrets.DO_ACCESS_TOKEN }} registry.digitalocean.com
            docker pull $PYTHON_IMAGE
            docker stop python-app-test || true
            docker rm python-app-test || true

            # Host 8000 -> Container 80 (As per your working production config)
            docker run -d --name python-app-test -p 8000:80 $PYTHON_IMAGE

            docker image prune -f
            sleep 45

  # ==========================================
  # BOX 7A: DAST SECURITY SCAN (BLOCKING MED/HIGH)
  # ==========================================
  dast-scan:
    name: DAST Security Scan
    needs: deploy-test
    runs-on: ubuntu-latest
    steps:
      - name: Wait for App
        run: timeout 300s bash -c 'until curl -sSf http://${{ secrets.TEST_IP }}:8000/docs > /dev/null; do echo "Waiting..."; sleep 5; done'

      - name: OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.10.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://${{ secrets.TEST_IP }}:8000/openapi.json"
          format: openapi
          fail_action: true
          allow_issue_writing: false
          cmd_options: "-I" # Only fail on Medium/High risks

      - name: Upload DAST Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-zap-report
          path: |
            report_html.html
            report_json.json

  # ==========================================
  # BOX 7B: PERFORMANCE TEST (LOCUST)
  # ==========================================
  load-test:
    name: Locust Load Test
    needs: dast-scan
    if: always() # Run performance even if DAST only found Low/Info issues
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Locust
        run: pip install locust
      - name: Run Locust
        run: |
          locust -f locustfile.py --headless -u 10 -r 5 --run-time 1m \
            --host http://${{ secrets.TEST_IP }}:8000 --html report.html
      - name: Upload Load Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-load-test-report
          path: report.html

  # ==========================================
  # BOX 7C: TAG FOR PRODUCTION
  # ==========================================
  tag-production:
    name: Tag Production Image
    needs: [dast-scan, load-test]
    runs-on: ubuntu-latest
    steps:
      - name: Login to DigitalOcean
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: _
          password: ${{ secrets.DO_ACCESS_TOKEN }}
      - name: Pull, Tag, and Push
        run: |
          docker pull registry.digitalocean.com/binitright/python-ml-app:${{ github.sha }}
          docker tag registry.digitalocean.com/binitright/python-ml-app:${{ github.sha }} \
                     registry.digitalocean.com/binitright/python-ml-app:production
          docker push registry.digitalocean.com/binitright/python-ml-app:production

  # ==========================================
  # BOX 8: PRODUCTION RELEASE (PAUSES FOR APPROVAL)
  # ==========================================
  deploy-production:
    name: Production Release
    needs: tag-production
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: SSH Deploy Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker login -u _ -p ${{ secrets.DO_ACCESS_TOKEN }} registry.digitalocean.com
            docker pull registry.digitalocean.com/binitright/python-ml-app:production
            docker stop python-app-prod || true
            docker rm python-app-prod || true

            # Consistent Host 8000 -> Container 80
            docker run -d --name python-app-prod --restart always -p 8000:80 registry.digitalocean.com/binitright/python-ml-app:production

            docker image prune -f
