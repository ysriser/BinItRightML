name: BinItRight Python CICD Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["master"]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # BOX 1: QUALITY & LOGIC
  # ==========================================
  quality-checks:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.pull_request == null || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Ruff (Lint)
        run: pip install ruff && ruff check .

      - name: Run Pytest (Unit)
        run: |
          pip install -r requirements.txt
          pip install pytest
          pytest --junitxml=reports/unit-test.xml || [ $? -eq 5 ]

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-unit-reports
          path: reports/

  # ==========================================
  # BOX 2: SCA (Dependency Security)
  # ==========================================
  sca-scan:
    name: SCA (Trivy)
    needs: [quality-checks]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.pull_request == null || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy SCA
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          format: "table"
          output: "sca-report.txt"
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-sca-results
          path: sca-report.txt

  # ==========================================
  # BOX 3: SAST (Code Security Enforcer)
  # ==========================================
  sast-scan:
    name: SAST (Bandit)
    needs: [quality-checks, sca-scan]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.pull_request == null || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-results.json || true

      - name: Upload SAST Fix List
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-sast-fix-list
          path: bandit-results.json

      - name: Check for High Risks
        run: |
          if grep -q '"issue_severity": "HIGH"' bandit-results.json; then
            echo "HIGH SEVERITY VULNERABILITIES DETECTED"
            exit 1
          fi

  # ==========================================
  # BOX 4: SHARED REGISTRY BUILD
  # ==========================================
  docker-build:
    name: Shared Build
    needs: sast-scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.pull_request == null || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Login to DigitalOcean Registry
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: _
          password: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Add this line to ensure it uses the credentials we just set up
          provenance: false
          tags: |
            registry.digitalocean.com/binitright/binitright-app:python-latest
            registry.digitalocean.com/binitright/binitright-app:python-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # BOX 5: TRANSIENT DEPLOY
  # ==========================================
  deploy-temp:
    name: Deploy to Temp Droplet
    if: github.event_name == 'pull_request'
    # if: github.ref != 'refs/heads/master' && (github.event_name == 'pull_request' || github.event.pull_request == null)
    needs: docker-build
    runs-on: ubuntu-latest
    outputs:
      droplet_ip: ${{ steps.get-ip.outputs.ip }}
      droplet_id: ${{ steps.create-droplet.outputs.id }}
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Create Temporary Droplet
        id: create-droplet
        run: |
          ID=$(doctl compute droplet create temp-dast-py-${{ github.sha }} \
            --region nyc1 --size s-1vcpu-1gb --image docker-20-04 \
            --ssh-keys ${{ secrets.SSH_KEY_ID }} --wait --format ID --no-header)
          echo "id=$ID" >> $GITHUB_OUTPUT

      - name: Get Droplet IP
        id: get-ip
        run: |
          IP=$(doctl compute droplet get ${{ steps.create-droplet.outputs.id }} --format PublicIPv4 --no-header)
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Wait for SSH to wake up
        run: |
          for i in {1..20}; do 
            if nc -zv -w 5 ${{ steps.get-ip.outputs.ip }} 22; then
              sleep 15
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: Deploy FastAPI via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.get-ip.outputs.ip }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 90s
          script: |
            until docker info >/dev/null 2>&1; do sleep 2; done
            docker login -u _ -p ${{ secrets.DO_ACCESS_TOKEN }} registry.digitalocean.com
            docker stop binitright-python || true
            docker rm binitright-python || true
            docker run -d --name binitright-python -p 80:80 registry.digitalocean.com/binitright/binitright-app:python-${{ github.sha }}

  # ==========================================
  # BOX 6: DAST ATTACK (ZAP API Scan)
  # ==========================================
  dast-scan:
    name: DAST (ZAP Attack)
    if: github.event_name == 'pull_request'
    # if: github.ref != 'refs/heads/master' && (github.event_name == 'pull_request' || github.event.pull_request == null)
    needs: deploy-temp
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.10.0 # Changed from v0.12.0 to v0.10.0
        with:
          # Use the built-in token so the Search API can validate the repo
          token: ${{ secrets.GITHUB_TOKEN }}
          target: "http://${{ needs.deploy-temp.outputs.droplet_ip }}/openapi.json"
          format: openapi
          fail_action: true
          # This replaces 'create_issue' for the API scan action
          allow_issue_writing: false
          issue_title: "ZAP Scan Report"

      - name: Upload DAST Findings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-zap-report
          path: |
            report_html.html
            report_json.json

  # ==========================================
  # BOX 6.5: PERFORMANCE TEST (Locust)
  # ==========================================
  load-test:
    name: Locust Load Test
    if: github.event_name == 'pull_request'
    needs: [deploy-temp, dast-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Locust
        run: pip install locust

      - name: Run Locust (Headless)
        run: |
          # -u: 50 concurrent users, -r: spawn 5 per sec, -t: run for 1 min
          locust -f locustfile.py \
            --headless \
            -u 50 \
            -r 5 \
            --run-time 1m \
            --host http://${{ needs.deploy-temp.outputs.droplet_ip }} \
            --html report.html

      - name: Upload Load Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-load-test-report
          path: report.html

  # ==========================================
  # BOX 7: CLEANUP
  # ==========================================
  cleanup:
    name: Cleanup
    needs: [deploy-temp, dast-scan,load-test]
    if: always() && github.ref != 'refs/heads/master' && needs.deploy-temp.outputs.droplet_id != ''
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Destroy Droplet
        run: doctl compute droplet delete ${{ needs.deploy-temp.outputs.droplet_id }} --force

  # ==========================================
  # BOX 8: PRODUCTION DEPLOY
  # ==========================================
  deploy-production:
    name: Production Deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: [docker-build]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Prod via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker login -u _ -p ${{ secrets.DO_ACCESS_TOKEN }} registry.digitalocean.com
            docker stop binitright-python-prod || true
            docker rm binitright-python-prod || true
            docker pull registry.digitalocean.com/binitright/binitright-app:python-latest
            docker run -d \
              --name binitright-python-prod \
              --restart always \
              -p 8000:80 \
              registry.digitalocean.com/binitright/binitright-app:python-latest

  # ==========================================
  # BOX 9: TARGETED PYTHON CLEANUP
  # ==========================================
  registry-maintenance:
    name: Prune Python Tags
    needs: [docker-build, deploy-production, cleanup]
    # Runs if build succeeded, even if deploy/cleanup were skipped.
    if: |
      always() && 
      needs.docker-build.result == 'success' && 
      !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Delete Old Python Tags (Keep 5)
        run: |
          # 1. Fetch tags - handles empty registry gracefully
          RAW_TAGS=$(doctl registry repository list-tags binitright-app --format Tag,UpdatedAt --no-header || echo "")

          if [ -z "$RAW_TAGS" ]; then
            echo "No tags found. Skipping prune."
            exit 0
          fi

          # 2. Filter for python- prefix, sort newest first, skip TOP 5
          # NR>5 tells awk to only print lines after the 5th one.
          TAGS_TO_DELETE=$(echo "$RAW_TAGS" | grep "^python-" | sort -k2 -r | awk 'NR>5 {print $1}')

          if [ -z "$TAGS_TO_DELETE" ]; then
            echo "Registry is already clean (5 or fewer Python tags)."
            exit 0
          fi

          # 3. Secure Deletion Loop
          for TAG in $TAGS_TO_DELETE; do
            # SAFETY: Never delete 'latest' or the specific SHA we just pushed
            if [[ "$TAG" != "python-latest" && "$TAG" != "python-${{ github.sha }}" ]]; then
              echo "Pruning old tag: $TAG"
              doctl registry repository delete-tag binitright-app $TAG --force
            fi
          done
