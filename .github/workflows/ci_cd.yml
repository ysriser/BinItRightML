name: BinItRight Python Ultimate DO Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["master"]

concurrency:
  # FIX: Aligning the group key so Push and PR events on the same branch compete for the same slot
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # BOX 1: QUALITY & LOGIC (Parallel)
  quality-checks:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Run Ruff (Lint)
        run: pip install ruff && ruff check .
      - name: Run Pytest (Unit)
        run: |
          pip install -r requirements.txt
          pip install pytest
          pytest --junitxml=reports/unit-test.xml || [ $? -eq 5 ]
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-unit-reports
          path: reports/

  # BOX 2: SCA (Dependency Security)
  sca-scan:
    name: SCA (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy SCA
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          format: "table"
          output: "sca-report.txt"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-sca-results
          path: sca-report.txt

  # BOX 3: SAST (Code Security Enforcer)
  sast-scan:
    name: SAST (Bandit)
    needs: [quality-checks, sca-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-results.json || true
      - name: Upload SAST Fix List
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-sast-fix-list
          path: bandit-results.json
      - name: Check for High Risks
        run: |
          if grep -q '"issue_severity": "HIGH"' bandit-results.json; then
            echo "HIGH SEVERITY VULNERABILITIES DETECTED"
            exit 1
          fi

  # BOX 4: SHARED REGISTRY BUILD
  docker-build:
    name: Shared Build
    needs: sast-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to DigitalOcean Registry
        uses: docker/login-action@v3
        with:
          registry: registry.digitalocean.com
          username: _
          password: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            registry.digitalocean.com/binitright/binitright-app:python-latest
            registry.digitalocean.com/binitright/binitright-app:python-${{ github.sha }}
          # This caches layers to make builds faster and more stable
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # BOX 5: TRANSIENT DEPLOY (PR ONLY)
  deploy-temp:
    name: Deploy to Temp Droplet
    if: github.event_name == 'pull_request'
    needs: docker-build
    runs-on: ubuntu-latest
    outputs:
      droplet_ip: ${{ steps.get-ip.outputs.ip }}
      droplet_id: ${{ steps.create-droplet.outputs.id }}
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}

      - name: Create Temporary Droplet
        id: create-droplet
        run: |
          ID=$(doctl compute droplet create temp-dast-py-${{ github.sha }} \
            --region nyc1 --size s-1vcpu-1gb --image docker-20-04 \
            --ssh-keys ${{ secrets.SSH_KEY_ID }} --wait --format ID --no-header)
          echo "id=$ID" >> $GITHUB_OUTPUT

      - name: Get Droplet IP
        id: get-ip
        run: |
          IP=$(doctl compute droplet get ${{ steps.create-droplet.outputs.id }} --format PublicIPv4 --no-header)
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Wait for SSH to wake up
        run: |
          echo "Probing Port 22 on ${{ steps.get-ip.outputs.ip }}..."
          for i in {1..20}; do 
            if nc -zv -w 5 ${{ steps.get-ip.outputs.ip }} 22; then
              echo "TCP Port 22 is open. Sleeping 15s to let SSH service initialize..."
              sleep 15
              exit 0
            fi
            echo "Attempt $i: Connection refused, retrying in 5s..."
            sleep 5
          done
          exit 1

      - name: Deploy FastAPI via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.get-ip.outputs.ip }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Increased handshake timeout to prevent the i/o timeout error
          timeout: 90s
          command_timeout: 15m
          script: |
            # Ensure Docker is actually ready before running commands
            until docker info >/dev/null 2>&1; do echo "Waiting for Docker daemon..."; sleep 2; done
            docker login -u _ -p ${{ secrets.DO_ACCESS_TOKEN }} registry.digitalocean.com
            docker stop binitright-python || true
            docker rm binitright-python || true
            docker run -d --name binitright-python -p 80:80 registry.digitalocean.com/binitright/binitright-app:python-${{ github.sha }}

  # BOX 6: DAST ATTACK (ZAP API Scan - PR ONLY)
  dast-scan:
    name: DAST (ZAP Attack)
    if: github.event_name == 'pull_request'
    needs: deploy-temp
    runs-on: ubuntu-latest
    steps:
      - name: OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.10.0
        with:
          target: "http://${{ needs.deploy-temp.outputs.droplet_ip }}/openapi.json"
          format: openapi
          allow_issue_writing: false
          fail_action: true
      - name: Upload DAST Findings
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-zap-report
          path: |
            report_html.html
            report_json.json

  # BOX 7: CLEANUP (PR ONLY)
  cleanup:
    name: Cleanup
    needs: [deploy-temp, dast-scan]
    # Logic: Only run if it's a PR AND a droplet was actually created (avoids errors on standard pushes)
    if: always() && github.event_name == 'pull_request' && needs.deploy-temp.outputs.droplet_id != ''
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_ACCESS_TOKEN }}
      - name: Destroy Droplet
        run: doctl compute droplet delete ${{ needs.deploy-temp.outputs.droplet_id }} --force

  # BOX 8: PRODUCTION (MASTER ONLY)
  deploy-production:
    name: ðŸš€ Production Deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    needs: [docker-build]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Prod via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker login -u _ -p ${{ secrets.DO_ACCESS_TOKEN }} registry.digitalocean.com
            docker stop binitright-python-prod || true
            docker rm binitright-python-prod || true
            docker pull registry.digitalocean.com/binitright/binitright-app:python-latest
            docker run -d \
              --name binitright-python-prod \
              --restart always \
              -p 8000:80 \
              registry.digitalocean.com/binitright/binitright-app:python-latest
