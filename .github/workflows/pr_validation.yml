name: Python PR Validation (Quality Gates)

on:
  pull_request:
    branches: ["master"]

jobs:
  # ==========================================
  # BOX 1: LINTING
  # ==========================================
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Run Ruff
        run: |
          pip install ruff
          # Output to a file for artifact storage
          ruff check . > lint-report.txt || true
      - name: Upload Lint Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-lint-reports
          path: lint-report.txt

  # ==========================================
  # BOX 2: UNIT TESTS + COVERAGE
  # ==========================================
  unit-tests:
    name: Unit Tests (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          pip install pytest pytest-cov
          pip install -r requirements.txt

      # Run tests with coverage
      - name: Run Pytest with Coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html --junitxml=reports/unit-test.xml || [ $? -eq 5 ]

      - name: Upload Unit Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-unit-reports
          path: reports/

      # NEW: Upload coverage for aggregation
      - name: Upload Coverage Reports
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-reports
          path: coverage.xml
          retention-days: 7

  # ==========================================
  # BOX 3: SCA
  # ==========================================
  sca-scan:
    name: SCA (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy SCA
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          format: "table"
          output: "sca-report.txt"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
      - name: Upload SCA Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-sca-results
          path: sca-report.txt

  # ==========================================
  # BOX 4: SAST
  # ==========================================
  sast-scan:
    name: SAST (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-results.json || true
      - name: Upload SAST Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-sast-results
          path: bandit-results.json

  # ==========================================
  # BOX 4: PYTHON BUILD (Verification)
  # ==========================================
  python-build:
    name: Python Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install wheel setuptools
          pip install -r requirements.txt
      - name: Verify Environment (Dry Run)
        run: |
          # This ensures the app can at least be 'imported' or 
          # that the entry point script is valid.
          python -m compileall .
      - name: Create Build Archive
        run: |
          zip -r python-app-pr.zip . -x "*.git*" "venv/*" "__pycache__/*"
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-app-binary-pr
          path: python-app-pr.zip
          retention-days: 1
